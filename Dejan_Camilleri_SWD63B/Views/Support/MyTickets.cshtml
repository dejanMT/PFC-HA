@using System.Linq
@using System.Security.Claims
@model IEnumerable<Dejan_Camilleri_SWD63B.Models.TicketPost>

@{
    ViewData["Title"] = "My Tickets";

    // get current user
    var currentEmail = User.FindFirst(ClaimTypes.Email)?.Value;

    // user’s own closed tickets
    var myClosedTickets = Model
        .Where(t => t.PostAuthorEmail == currentEmail && t.ClosedTicket)
        .ToList();

    // technician’s assigned (in-progress) tickets
    var assignedTickets = Model
        .Where(t => t.SupportAgent == currentEmail && !t.ClosedTicket)
        .OrderByDescending(t => t.OpenDate)
        .ToList();

    // technician’s own closed tickets
    var closedByMeTickets = Model
        .Where(t => t.SupportAgent == currentEmail && t.ClosedTicket)
        .OrderByDescending(t => t.CloseDate)
        .ToList();

    // simple role‐detection: technician if they have any assigned or closed-by-me
    var isTechnician = assignedTickets.Any() || closedByMeTickets.Any();
}

<h2>@ViewData["Title"]</h2>

@if (!isTechnician)
{
    <h4>Your Previously Closed Tickets</h4>
    @if (!myClosedTickets.Any())
    {
        <div class="alert alert-info">You have no closed tickets yet.</div>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Priority</th>
                    <th>Opened On</th>
                    <th>Closed On</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in myClosedTickets)
                {
                    <tr>
                        <td>@t.PostTitle</td>
                        <td>@t.Priority</td>
                        <td>@t.OpenDate.ToLocalTime()</td>
                        <td>
                            @t.CloseDate?.ToLocalTime()
                        </td>
                        <td>
                            <a asp-action="Details" asp-route-ticketId="@t.TicketId"
                               class="btn btn-sm btn-info">
                                View
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}
else
{
    <!-- Technician view: two tabs -->
    <ul class="nav nav-tabs mb-3" id="myTicketsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="assigned-tab" data-bs-toggle="tab"
               href="#assigned" role="tab" aria-controls="assigned"
               aria-selected="true">
                Assigned (@assignedTickets.Count)
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="closed-tab" data-bs-toggle="tab"
               href="#closed" role="tab" aria-controls="closed"
               aria-selected="false">
                Closed (@closedByMeTickets.Count)
            </a>
        </li>
    </ul>

    <div class="tab-content" id="myTicketsTabContent">
        <!-- Assigned Tickets Tab -->
        <div class="tab-pane fade show active" id="assigned"
             role="tabpanel" aria-labelledby="assigned-tab">
            @if (!assignedTickets.Any())
            {
                <div class="alert alert-info">No tickets currently assigned to you.</div>
            }
            else
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Priority</th>
                            <th>Opened On</th>
                            <th>Author</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var t in assignedTickets)
                        {
                            <tr>
                                <td>@t.PostTitle</td>
                                <td>@t.Priority</td>
                                <td>@t.OpenDate.ToLocalTime():g</td>
                                <td>@t.PostAuthorEmail</td>
                                <td>
                                    <a asp-action="Details" asp-route-ticketId="@t.TicketId"
                                       class="btn btn-sm btn-info">
                                        View
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        <!-- Closed by Me Tab -->
        <div class="tab-pane fade" id="closed"
             role="tabpanel" aria-labelledby="closed-tab">
            @if (!closedByMeTickets.Any())
            {
                <div class="alert alert-info">You haven’t closed any tickets yet.</div>
            }
            else
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Priority</th>
                            <th>Opened On</th>
                            <th>Closed On</th>
                            <th>Author</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var t in closedByMeTickets)
                        {
                            <tr>
                                <td>@t.PostTitle</td>
                                <td>@t.Priority</td>
                                <td>@t.OpenDate.ToLocalTime():g</td>
                                <td>@t.CloseDate?.ToLocalTime().ToString("g")</td>
                                <td>@t.PostAuthorEmail</td>
                                <td>
                                    <a asp-action="Details" asp-route-ticketId="@t.TicketId"
                                       class="btn btn-sm btn-info">
                                        View
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
}
